---
title: "Final Project"
author: "Aldrin Carbonell, Johnny Nguyen, Andy Tseng, Samuel Perng, Justin Choi"
date: "March 6, 2019"
output: html_document
---
# Gentrification of King County, Washington: 2009 & 2017

```{r setup, results='hide', message=FALSE, warning=FALSE, echo=FALSE}
library(rgdal)
library(sp)
library(leaflet)
library(raster)
library(tmap)
library(dplyr)
library(tigris)
```

```{r include=FALSE, message=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#loading in the data and cutting it to the columns we need 
#2009
ethnicity2009<-read.csv(file="data/2009_Ethnicity/ACS_09_5YR_B02001_with_ann.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
ethnicity2009 <- ethnicity2009[-1,c("GEO.id", "GEO.id2","HD01_VD01","HD01_VD02")]
colnames(ethnicity2009)[colnames(ethnicity2009)=="HD01_VD01"] <- "ethnicity.HD01_VD01"
colnames(ethnicity2009)[colnames(ethnicity2009)=="HD01_VD02"] <- "ethnicity.HD01_VD02"

#education
edu2009<-read.csv(file="data/2009_Education_Attainment/ACS_09_5YR_S1501_with_ann.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
edu2009 <- edu2009[-1,c("GEO.id", "GEO.id2","HC01_EST_VC06","HC01_EST_VC12")]

#housing
housing2009 <-read.csv(file="data/2009_Housing/ACS_09_5YR_B25003_with_ann.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
housing2009 <- housing2009[-1,c("GEO.id", "GEO.id2","HD01_VD01","HD01_VD03")]

#home value
medianhome2009 <- read.csv(file="data/2009_Median_Household_Value/ACS_09_5YR_B25077_with_ann.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
medianhome2009 <- medianhome2009[-1,c("GEO.id", "GEO.id2","HD01_VD01")]
colnames(medianhome2009)[colnames(medianhome2009)=="HD01_VD01"] <- "home.HD01_VD01"

#2017 data
#ethnicty
ethnicity2017<-read.csv(file="data/2017_Ethnicity/ACS_17_5YR_B02001_with_ann.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
ethnicity2017 <- ethnicity2017[-1,c("GEO.id", "GEO.id2","HD01_VD01","HD01_VD02")]
colnames(ethnicity2017)[colnames(ethnicity2017)=="HD01_VD01"] <- "ethnicity.HD01_VD01"
colnames(ethnicity2017)[colnames(ethnicity2017)=="HD01_VD02"] <- "ethnicity.HD01_VD02"

#education
edu2017<-read.csv(file="data/2017_Education_Attainment/ACS_17_5YR_S1501_with_ann.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
edu2017 <- edu2017[-1,c("GEO.id", "GEO.id2","HC01_EST_VC08","HC01_EST_VC14")]

#poverty
poverty2017 <-read.csv(file="data/2017_Poverty/ACS_17_5YR_S1701_with_ann.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
poverty2017 <- poverty2017[-1,c("GEO.id", "GEO.id2","HC03_EST_VC01")]

#housing
housing2017 <-read.csv(file="data/2017_Housing/ACS_17_5YR_B25003_with_ann.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
housing2017 <- housing2017[-1,c("GEO.id", "GEO.id2","HD01_VD01","HD01_VD03")]

#home value
medianhome2017 <- read.csv(file="data/2017_Median_Household_Value/ACS_17_5YR_B25077_with_ann.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
medianhome2017 <- medianhome2017[-1,c("GEO.id", "GEO.id2","HD01_VD01")]
colnames(medianhome2017)[colnames(medianhome2017)=="HD01_VD01"] <- "home.HD01_VD01"



```
```{r message=FALSE, warning=FALSE, echo=FALSE}
#get percentage for each variable and create z scores for each percentage
#get percent white population count
ethnicity2009 <- ethnicity2009 %>% 
  mutate(percentwhite = (as.numeric(ethnicity.HD01_VD02)/as.numeric(ethnicity.HD01_VD01)) * 100)

#generate z scores for white population percent
ethnicity2009 <- ethnicity2009 %>% 
  mutate(percentwhite.zscore = scale(as.numeric(percentwhite)))

#get percent of people over 25 who have bachelor's degree
edu2009 <- edu2009 %>% 
  mutate(percentbach = (as.numeric(HC01_EST_VC12)/as.numeric(HC01_EST_VC06)) * 100)

#generate z scores
edu2009 <- edu2009 %>% 
  mutate(percentbach.zscore = scale(as.numeric(percentbach)))

#get percent of renter poopulation
housing2009 <- housing2009 %>% 
  mutate(percentrent = (as.numeric(HD01_VD03)/as.numeric(HD01_VD01)) * 100)

#generate z scores
housing2009 <- housing2009 %>% 
  mutate(percentrent.zscore = scale(as.numeric(percentrent)))

#generate z scores
medianhome2009 <- medianhome2009 %>% 
  mutate(home.zscore = scale(as.numeric(home.HD01_VD01)))

```

```{r echo=FALSE,  message=FALSE, warning=FALSE}
#get percentage for each variable and create z scores for each percentage
#get percent white population count
ethnicity2017 <- ethnicity2017 %>% 
  mutate(percentwhite = (as.numeric(ethnicity.HD01_VD02)/as.numeric(ethnicity.HD01_VD01)) * 100)

#generate z scores for white population percent
ethnicity2017 <- ethnicity2017 %>% 
  mutate(percentwhite.zscore = scale(as.numeric(percentwhite)))

#get percent of people over 25 who have bachelor's degree
edu2017 <- edu2017 %>% 
  mutate(percentbach = (as.numeric(HC01_EST_VC14)/as.numeric(HC01_EST_VC08)) * 100)

#generate z scores
edu2017 <- edu2017 %>% 
  mutate(percentbach.zscore = scale(as.numeric(percentbach)))

#get percent of people over 25 who have bachelor's degree
housing2017 <- housing2017 %>% 
  mutate(percentrent = (as.numeric(HD01_VD03)/as.numeric(HD01_VD01)) * 100)

#generate z scores
housing2017 <- housing2017 %>% 
  mutate(percentrent.zscore = scale(as.numeric(percentrent)))

#generate z scores
medianhome2017 <- medianhome2017 %>% 
  mutate(home.zscore = scale(as.numeric(home.HD01_VD01)))

```

```{r echo=FALSE,  message=FALSE, warning=FALSE}
#loading in king county census tract
#for 2017
KC_shape <- shapefile("data/king10ct/king10ct.shp")

#merging gentrification variables together
temporary <- merge(ethnicity2017, edu2017, by="GEO.id2")
temporary <- merge(temporary, housing2017, by="GEO.id2")
temporary <- merge(temporary, medianhome2017, by="GEO.id2")

#remove duplicate columns
temporary <- temporary[, !duplicated(colnames(temporary))]

#flatten columns into 1d vectors
temporary$percentwhite.zscore <- temporary$percentwhite.zscore[,1]
temporary$percentbach.zscore <- temporary$percentbach.zscore[,1]
temporary$percentrent.zscore <- temporary$percentrent.zscore[,1]
temporary$home.zscore <- temporary$home.zscore [,1]

#make index by adding z scores and averaging them
temporary <- temporary %>%
  mutate(gscore = (percentwhite.zscore + percentbach.zscore + percentrent.zscore + home.zscore)/4)

#merge dataframe with z scores to shapefile
KC_shape_merged <- merge(KC_shape, temporary, by.x='GEOID10',
                         by.y='GEO.id2')

#get rid of polygons that have no land 
KC_shape_merged <- KC_shape_merged[KC_shape_merged$ALAND10 != 0 ,]

```

```{r include=FALSE, echo=FALSE,  message=FALSE, warning=FALSE}
#foor 2009
#loading in king county census tract
KC_shape2 <- shapefile("data/king10ct/king10ct.shp")
KC_water <- area_water("WA", "King")

#merging gentrification variables together
temporary2 <- merge(ethnicity2009, edu2009, by="GEO.id2")
temporary2 <- merge(temporary2, housing2009, by="GEO.id2")
temporary2 <- merge(temporary2, medianhome2009, by="GEO.id2")

#remove duplicate columns
temporary2 <- temporary2[, !duplicated(colnames(temporary2))]

#flatten columns into 1d vectors
temporary2$percentwhite.zscore <- temporary2$percentwhite.zscore[,1]
temporary2$percentbach.zscore <- temporary2$percentbach.zscore[,1]
temporary2$percentrent.zscore <- temporary2$percentrent.zscore[,1]
temporary2$home.zscore <- temporary2$home.zscore [,1]

#make index by adding z scores and averaging them
temporary2 <- temporary2 %>%
  mutate(gscore2= (percentwhite.zscore + percentbach.zscore + percentrent.zscore + home.zscore)/4)

#merge dataframe with z scores to shapefile
KC_shape_merged2 <- merge(KC_shape, temporary2, by.x='GEOID10',
                         by.y='GEO.id2')

#get rid of polygons that have no land 
KC_shape_merged2 <- KC_shape_merged2[KC_shape_merged2$ALAND10 != 0 ,]


```


##Gentrification in King County, Washington
The variables that we ussed to measure Gentrification in the King County area are Percent of White Poppulation, Percent of Population who are 25 years and older who have a Bachelor's Degree, Percent of Population who are renters, and the Median Home Value. To compare the Gentrification of 2017 with 2009, we create an index that will serve as a baseline for Gentrification / Class Value in each census tract. This is called the Census Tract Area Value in this case. 

The reason why we want to create a index that will represent the Census Tract Value is to see how much of the Census Tract has changed from 2009. The difference in Census Tract Values will serve as a measurement of Gentrification. 

To create the index to measure the Census Tract Area Value in both years, we converted all our variables to z scores. Converting all our variables to z scores allows us to standardize the variables so that they are comparable to eachother. Then we add the z scores up and divid by 4 to get a composite z score that will represent the Census Tract Value. 

This Censuus Tract Area Value can be a measurement of well-being of the tract. To get gentrification we will find the difference of the well-being of each tract! 

###Census Tract Area Value in King County, Washington 2009
```{r echo=FALSE,  message=FALSE, warning=FALSE}
#get range for data
z_scores <- as.numeric(KC_shape_merged2$gscore2)
#bins <- quantile(population, probs = c(0.25, 0.50, .75,1))
bins <- quantile(z_scores, probs = seq(0, 1, by = 0.20), na.rm = TRUE)
#create color pallete 
pal <- colorBin("YlOrRd", domain = KC_shape_merged2$gscore2, bins = bins)

#labels for leaflet
labels <- sprintf(
  "<strong>%s</strong><br>
  Percent of Population White: %5.1f%%<br>
  Percent of Population with Bachelor's Degree: %5.1f%%<br>
  Percent of Population who Rent: %5.1f%% <br>
  Median House Value: $%s ",
  KC_shape_merged2$NAMELSAD10, KC_shape_merged2$percentwhite, KC_shape_merged2$percentbach,
  KC_shape_merged2$percentrent, KC_shape_merged2$home.HD01_VD01
) %>% lapply(htmltools::HTML)


#change projection of shapefile to work with leaflet
PRO <- sp::CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
KC_shape_merged2 <- sp::spTransform(KC_shape_merged2,PRO)
KC_water <- sp::spTransform(KC_water,PRO)

#leaflet map
m <- leaflet(KC_shape_merged2) %>%
  addProviderTiles(providers$OpenStreetMap) %>% 
  addPolygons(
  fillColor = ~pal(as.numeric(KC_shape_merged2$gscore2)),
  weight = 1,
  opacity = 1,
  color = "white",
  dashArray = "",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 5,
    color = "white",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
    label = labels) 
 # addPolygons(data=KC_water, weight = 1, color = "blue",fillOpacity = 1
 # )
#add legend
m <- m %>% 
    addLegend("bottomright", pal = pal, values = ~KC_shape_merged2$gscore2,
    title = "Census Tract Area Value Index",
    opacity = .7
  ) 

m
```

###Census Tract Area Value in King County, Washington 2017

```{r echo=FALSE,  message=FALSE, warning=FALSE}
#get range for data
#for 2017
z_scores <- as.numeric(KC_shape_merged$gscore)
#bins <- quantile(population, probs = c(0.25, 0.50, .75,1))
bins <- quantile(z_scores, probs = seq(0, 1, by = 0.20), na.rm = TRUE)
#create color pallete 
pal <- colorBin("YlOrRd", domain = KC_shape_merged$gscore, bins = bins)

#labels for leaflet
labels <- sprintf(
  "<strong>%s</strong><br>
  Percent of Population White: %5.1f%%<br>
  Percent of Population with Bachelor's Degree: %5.1f%%<br>
  Percent of Population who Rent: %5.1f%% <br>
  Median House Value: $%s ",
  KC_shape_merged$NAMELSAD10, KC_shape_merged$percentwhite, KC_shape_merged$percentbach,
  KC_shape_merged$percentrent, KC_shape_merged$home.HD01_VD01) %>% lapply(htmltools::HTML)


#change projection of shapefile to work with leaflet
PRO <- sp::CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
KC_shape_merged <- sp::spTransform(KC_shape_merged,PRO)

#leaflet map
m2 <- leaflet(KC_shape_merged) %>%
  addProviderTiles(providers$OpenStreetMap) %>% 
  addPolygons(
  fillColor = ~pal(as.numeric(KC_shape_merged$gscore)),
  weight = 1,
  opacity = 1,
  color = "white",
  dashArray = "",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 5,
    color = "white",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
    label = labels)
#add legend
m2 <- m2 %>% 
    addLegend("bottomright", pal = pal, values = ~KC_shape_merged$gscore,
    title = "Census Tract Area Value Index",
    opacity = .7
  ) 
m2
```

###Change in Census Tract Area Value in King County, Washington 2009 - 2017 (Gentrification)

```{r message=FALSE, warning=FALSE, echo=FALSE}
difference <- merge(temporary, temporary2, by="GEO.id2")
difference <- difference %>%
 mutate(gscorediff = (as.numeric(gscore) - as.numeric(gscore2)))

KC_shape_merged3 <- merge(KC_shape, difference, by.x='GEOID10',
                         by.y='GEO.id2')
#difference <- difference[, !duplicated(colnames(difference))]
#get rid of polygons that have no land 
KC_shape_merged3 <- KC_shape_merged3[KC_shape_merged3$ALAND10 != 0 ,]

z_scores <- as.numeric(KC_shape_merged3$gscorediff)
#bins <- quantile(population, probs = c(0.25, 0.50, .75,1))
bins <- quantile(z_scores, probs = seq(0, 1, by = 0.20), na.rm = TRUE)
#create color pallete 
pal <- colorBin("YlOrRd", domain = KC_shape_merged3$gscorediff, bins = bins)

#labels for leaflet
labels <- sprintf(
  "<strong>%s</strong><br>
  GScore 2009: %5.3f<br>
  GScore 2017: %5.3f<br>
  Change in GScore: %5.3f<br>
 ",KC_shape_merged$NAMELSAD10, KC_shape_merged3$gscore2,KC_shape_merged3$gscore, KC_shape_merged3$gscorediff ) %>% lapply(htmltools::HTML)


#change projection of shapefile to work with leaflet
PRO <- sp::CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
KC_shape_merged3 <- sp::spTransform(KC_shape_merged3,PRO)

#leaflet map
m3 <- leaflet(KC_shape_merged3) %>%
  addProviderTiles(providers$OpenStreetMap) %>% 
   addPolygons(
  fillColor = ~pal(as.numeric(KC_shape_merged3$gscorediff)),
  weight = 1,
  opacity = 1,
  color = "white",
  dashArray = "",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 5,
    color = "white",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
    label = labels)
#add legend
m3 <- m3 %>% 
    addLegend("bottomright", pal = pal, values = ~KC_shape_merged3$gscorediff,
    title = "Change Census Tract Area Value Index",
    opacity = .7
  ) 
m3

```

